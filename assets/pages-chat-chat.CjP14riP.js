import{U as e,V as t,W as a,X as s,Y as i,r as l,q as o,M as n,g as u,b as r,D as c,t as d,R as p,Z as m,_ as f,$ as g,a0 as h,E as v,G as y,a1 as _,a2 as k,d as x,e as w,w as b,l as F,j as T,K as $,i as C,f as j,y as z,P as I,F as D,Q as L,a3 as N,h as S,z as U,B as M,L as B,a4 as P,a5 as E,a6 as W,S as J,a7 as O,a8 as V,a9 as K,O as R,aa as q,A as G,n as A,ab as H,J as Q,m as X,ac as Y}from"./index-o4dV0oGq.js";import{p as Z}from"./common.mgsQid_K.js";import{I as ee,F as te}from"./req.CPxC-5sD.js";import{_ as ae}from"./_plugin-vue_export-helper.BCo6x5W8.js";let se=!1,ie=`ws://${ee}:8081`;e((function(e){console.log("WebSocket连接已打开"),se=!0}));const le=e=>{se?i({data:JSON.stringify({event:"login",uid:e}),success:function(e){},fail:function(e){throw new Error("登录消息发送失败:",e)}}):setTimeout((()=>{le(e)}),100)},oe=e=>{se&&i({data:JSON.stringify({event:"message",sendData:e}),success:function(e){},fail:function(e){throw new Error("消息发送失败:",e)}})},ne=(e={id:1e3})=>te.get({url:"/getuserinfo_userId",data:{...e}}),ue=(e={file:file},t=(()=>{}))=>te.uploadFile({url:"/upload_static",data:{...e},callback:t}),re=ae({__name:"chat",setup(e){const{proxy:ee}=B();let ae=l(0),re=o((()=>`  padding-bottom: ${ae.value}px;`)),ce=l(!1),de=0,pe=1,me=pe,fe=l(!1),ge=l(!1),he=l("height:38rpx ;"),ve=l(""),ye=l("height:300rpx;"),_e=l("bottom:env(safe-area-inset-bottom);"),ke=l(""),xe=l("height: 100%;"),we=l(0),be=!1,Fe=n([]),Te=0,$e=0,Ce="",je=u("heightForMore"),ze=l(0),Ie=[],De=l(!1),Le=l(1),Ne=n([]),Se=l(""),Ue=l(""),Me=l({});function Be(e){A("my"==e?{url:`/pages/user/user?userId=${Te}&friendStatus=200`}:{url:`/pages/user/user?userId=${$e}&friendStatus=200&remark=${Ce}`})}async function Pe(e){if(!e.isLoading)try{c();let t=`${te.baseUrl}/getFile_static?filePath=${e.message}`,a=await((e={filePath:filePath})=>te.get({url:"/isFound",data:{...e}}))({filePath:e.message});if(200!=a.status)return new Error(a.msg);let s=document.createElement("a");s.href=t,s.download=e.fileName,setTimeout((()=>{s.click()}),100),y()}catch(t){y(),v({title:"下载失败请稍后重试",icon:"error",duration:1500})}}function Ee(e){ge.value=!0,setTimeout((()=>{Le.value=Le.value+1,et(Le.value).then((()=>{setTimeout((()=>{}),100)})),ge.value=!1}),1e3)}function We(e){e.detail.lineCount<6&&(he.value=`height:${38*e.detail.lineCount}rpx ;`),p((()=>{qe(),0!==ve.value.length&&setTimeout((()=>{we.value=0,p((()=>{Ge()}))}),80)}))}function Je(e){}function Oe(e){me==de?(me=pe,P(),setTimeout((()=>{fe.value=!0}),100)):me=de,1==ce.value&&(ke.value="top:calc(44px);",_e.value="bottom:env(safe-area-inset-bottom);"),ce.value=!1}function Ve(e){P(),fe.value=!1}function Ke(e){null!=e&&(ze.value=e),ce.value=!ce.value;let t=je;ce.value?(_e.value=`bottom:${t}rpx;`,ke.value=`top:calc(44px  - ${t}rpx);`,me==pe&&(me=de)):(ke.value="top:calc(44px );",_e.value="bottom:env(safe-area-inset-bottom);",setTimeout((()=>{fe.value=!0}),80))}function Re(e){if(""==ve.value.trim())return ve.value="";let t={uid:Te,fid:$e,msg:ve.value.trim(),type:0,isFriend:be};ve.value="",oe(t)}function qe(){$().in(ee).select(".input").boundingClientRect((e=>{ae.value=e.height+10})).exec()}function Ge(){we.value=999999999}function Ae(e){me==de&&(me=pe),ce.value&&(ce.value=!ce.value,ke.value="top:calc(44px);",_e.value="bottom:env(safe-area-inset-bottom);"),me=pe}function He(e){ze.value=e}function Qe(e){var t;ze.value=null==(t=null==e?void 0:e.detail)?void 0:t.current}function Xe(e,t=2){if(0===e)return"0 Bytes";const a=t<0?0:t,s=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,s)).toFixed(a))+" "+["Bytes","KB","MB","GB","TB"][s]}function Ye(e){switch(e){case"tupian":E({count:1,sizeType:["original","compressed"],sourceType:["album"],success:async({tempFilePaths:e,tempFiles:t})=>{if("image"==t[0].type.split("/")[0]){let a={userID:Te,friendID:$e,message:e[0],type:1,isFriend:be,time:(new Date).getTime(),_id:(new Date).getTime(),fileName:t[0].name,size:t[0].size};Fe.push({type:"msg",data:a}),Me.value[Fe.length-1]=!0,we.value=0,p((()=>{Ge()}));try{let e={uid:Te,fid:$e,msg:"",type:1,isFriend:be,size:t[0].size};Ie.push("task");let a=await ue({file:t[0]});Ie.pop();let s=te.baseUrl,i=a.fileUrl.split("/").slice(1).join("/");e.msg=`${s}/static/${i}`,e.type=1,oe(e)}catch{Ie.pop(),v({title:"上传失败",icon:"error",mask:!0,duration:500})}}else v({title:"请选择图片格式文件",icon:"error",duration:1e3})},fail:e=>{v({title:"选择文件失败",icon:"error",mask:!0})}});break;case"wenjian":W({type:"all",success:async({tempFilePaths:e,tempFiles:t})=>{if(t[0].size<=104857600){let e=new Set(["ai","avi","bmp","crd","csv","dll","doc","docx","dwg","eps","exe","flv","gif","html","iso","java","jpg","mdb","mid","mov","mp3","mp4","mpeg","pdf","ppt","png","ps","psd","pub","rar","raw","rss","svg","tiff","txt","wav","wma","xml","xsl","zip"]),a=t[0].name.split(".").pop(),s={userID:Te,friendID:$e,message:"",type:3,isFriend:be,time:(new Date).getTime(),_id:(new Date).getTime(),size:t[0].size,isLoading:!0,progress:0,fileName:t[0].name,suffix:""};e.has(a)?s.suffix=a.toLocaleUpperCase():s.suffix="_",Fe.push({type:"msg",data:s});let i=Fe.length-1;we.value=0,p((()=>{Ge()}));try{let e={uid:Te,fid:$e,msg:"",type:3,isFriend:be,size:t[0].size};Ie.push("task");let a=await ue({file:t[0]},(e=>{Fe[i].data.progress=e.progress}));Ie.pop(),e.msg=a.fileUrl,oe(e)}catch{Ie.pop(),v({title:"文件上传失败",icon:"error",mask:!0,duration:500})}}else v({title:"请选择小于等于100M的文件",icon:"error",duration:1e3})},fail:e=>{v({title:"选择文件失败",icon:"error",mask:!0})}});break;case"paishe":E({count:1,sizeType:["original","compressed"],sourceType:["camera"],success:async({tempFilePaths:e,tempFiles:t})=>{if("image"==t[0].type.split("/")[0]){let a={userID:Te,friendID:$e,message:e[0],type:1,isFriend:be,time:(new Date).getTime(),_id:(new Date).getTime(),fileName:t[0].name,size:t[0].size,isLoading:!0};Fe.push({type:"msg",data:a}),we.value=0,p((()=>{Ge()}));try{let e={uid:Te,fid:$e,msg:"",type:1,isFriend:be,size:t[0].size};Ie.push("task");let a=await ue({file:t[0]});Ie.pop();let s=te.baseUrl,i=a.fileUrl.split("/").slice(1).join("/");e.msg=`${s}/static/${i}`,e.type=1,oe(e)}catch{Ie.pop(),v({title:"上传失败",icon:"error",mask:!0,duration:500})}}else v({title:"请选择图片格式文件",icon:"error",duration:1e3})},fail:e=>{v({title:"选择文件失败",icon:"error",mask:!0})}})}}function Ze(e){let{message:t}=e,a=t.split("/").pop(),s=a.split(".").pop(),i=a.split("-[]-").shift(),l=new Set(["ai","avi","bmp","crd","csv","dll","doc","docx","dwg","eps","exe","flv","gif","html","iso","java","jpg","mdb","mid","mov","mp3","mp4","mpeg","pdf","ppt","png","ps","psd","pub","rar","raw","rss","svg","tiff","txt","wav","wma","xml","xsl","zip"]);return e.fileName=i+"."+s,l.has(s)?e.suffix=s.toLocaleUpperCase():e.suffix="_",e}async function et(e){let t={uid:Te,fid:$e,page:e,limit:20},a=[],{data:s}=await((e={uid:""})=>te.post({url:"/getnewestmessage",data:{...e}}))(t);s.sort(((e,t)=>e.time-t.time));for(let i=0;i<s.length;i++)0!=i?s[i].time-s[i-1].time>=6e5?(a.push({data:s[i].time,type:"time"}),3==s[i].type&&(s[i]=Ze(s[i])),a.push({data:s[i],type:"msg"})):(3==s[i].type&&(s[i]=Ze(s[i])),a.push({data:s[i],type:"msg"})):(a.push({data:s[i].time,type:"time",page:Le.value}),3==s[i].type&&(s[i]=Ze(s[i])),a.push({data:s[i],type:"msg"}));if(0==Fe.length)for(let i=0;i<a.length;i++)Fe.push(a[i]);else for(let i=a.length-1;i>=0;i--)Fe.unshift(a[i]);return 2}return async function(){for(let e=1;e<=13;e++)Ne.push(`${te.baseUrl}/static/emoji/xiaoeyu${e}.jpg`)}(),r((async e=>{c({mask:!0}),Te=e.my,$e=e.target,Ce=e.remark,d({title:Ce}),t({url:ie,success:function(e){console.log("WebSocket连接成功")},fail:function(e){console.error("WebSocket连接失败:",e),setTimeout((()=>{t({url:ie})}),5e3)}}),a((function(e){console.log("WebSocket连接已关闭"),se=!1,setTimeout((()=>{t({url:ie})}),5e3)})),s((function(e){console.error("WebSocket错误:",e),se=!1,setTimeout((()=>{t({url:ie})}),5e3)})),await((e={myId:"",targetId:""})=>te.post({url:"/clearunreadmsg",data:{...e}}))({myId:Te,targetId:$e}),le(Te);let{data:i}=await ne({id:$e}),{data:l}=await ne({id:Te});Se.value=`${te.baseUrl}/static/${l.img}`,Ue.value=`${te.baseUrl}/static/${i.img}`,await et(Le.value);let{status:o}=await((e={uid:"",fid:""})=>te.post({url:"/checkstatus",data:{...e}}))({uid:Te,fid:$e});200==o&&(be=!0),qe(),p((()=>{we.value=0,setTimeout((()=>{Ge()}),100),De.value=!0,y()}))})),m((()=>{let e=f().windowHeight;xe.value=`height:${e}px;`;let t=u("heightForMore");t&&(ye.value=`height:${t}rpx;`),g((function(e){var t,a;let s=JSON.parse(e.data),{msg:i}=s;if("message"===s.event){if(1==i.type){let e,a=i.message.split("/"),s=a[a.length-1].split("-[]-"),l=s[0]+"."+s[s.length-1].split(".")[1];for(let i=Fe.length-1;i>=0;i--)if((null==(t=Fe[i].data)?void 0:t.fileName)==l&&1==Fe[i].data.type){e=i;break}if(null!=e)return Me.value[e]=!1,we.value=0,void p((()=>{Ge()}))}if(3==i.type){if(i.userID===Te){let e;i.isLoading=!1,i.fileName=i.message.split("/").pop().split("-[]-").shift()+"."+i.message.split(".").pop(),i.suffix=i.message.split(".").pop().toLocaleUpperCase();for(let t=Fe.length-1;t>=0;t--)if((null==(a=Fe[t].data)?void 0:a.isLoading)&&3==Fe[t].data.type&&Fe[t].data.fileName==i.fileName){e=t;break}return null!=e&&(Fe[e].data.message=i.message,Fe[e].data.time=i.time,Fe[e].data._id=i._id,Fe[e].data.isLoading=!1),void p((()=>{we.value=0,Ge()}))}i.isLoading=!1,i.fileName=i.message.split("/").pop().split("-[]-").shift()+"."+i.message.split(".").pop(),i.suffix=i.message.split(".").pop().toLocaleUpperCase()}let e=Fe[Fe.length-1];if(!e)return Fe.push({data:+i.time,type:"time"}),void Fe.push({data:i,type:"msg"});i.time-e.data.time>=6e5?(Fe.push({data:+i.time,type:"time"}),Fe.push({data:i,type:"msg"})):Fe.push({data:i,type:"msg"})}we.value=0,p((()=>{Ge()}))}))})),h((()=>{Ie.length>0&&v({title:"请不要刷新浏览器,否则上传或下载任务以及记录将被取消",icon:"none",duration:2e3}),y()})),_((()=>{se&&i({data:JSON.stringify({event:"logout"}),success:function(e){},fail:function(e){throw new Error("消息发送失败:",e)}})})),(e,t)=>{const a=Q,s=C,i=X,l=Y,o=J,n=O,u=V,r=K,c=k("lazy");return x(),w(s,{class:"layout_top",style:F([T(ke),T(xe)])},{default:b((()=>[j(s,{class:"chatLayout",style:F(T(re))},{default:b((()=>[j(o,{"scroll-y":"true",class:"content","scroll-top":T(we),"scroll-with-animation":T(De),"show-scrollbar":!1,"refresher-enabled":"",onRefresherrefresh:Ee,"refresher-background":"#eee","refresher-triggered":T(ge),onClick:Ae},{default:b((()=>[(x(!0),z(D,null,I(T(Fe),((e,o)=>{var n,u,r,d,p,m;return x(),w(s,{class:S(["chat_item","time"==e.type?"time":"",0==(null==(n=e.data)?void 0:n.type)?"text":"",1==(null==(u=e.data)?void 0:u.type)?"image":"",3==(null==(r=e.data)?void 0:r.type)?"file":"",(null==(d=e.data)?void 0:d.userID)==T(Te)?"right":"",(null==(p=e.data)?void 0:p.userID)==T($e)?"left":"",(null==e?void 0:e.page)?`page${e.page}`:""]),key:(null==(m=e.data)?void 0:m._id)?e.data._id:e.data},{default:b((()=>{var n,u;return[M(R("time"==e.type?T(Z)(+e.data):"")+" ",1),"time"!=e.type&&(null==(n=e.data)?void 0:n.userID)==T($e)&&T($e)!=T(Te)?(x(),w(s,{key:0,class:"item_img"},{default:b((()=>[j(a,{src:T(Ue),mode:"scaleToFill",onClick:t[0]||(t[0]=e=>Be("friend"))},null,8,["src"])])),_:1})):U("",!0),"time"!=e.type?(x(),w(s,{key:1,class:"item_content"},{default:b((()=>{var t;return["0"==e.data.type?(x(),w(i,{key:0},{default:b((()=>{var t;return[M(R(null==(t=e.data)?void 0:t.message),1)]})),_:2},1024)):U("",!0),"1"==e.data.type?q((x(),z("img",{key:1,mode:"widthFix",onClick:t=>{var a,s;return s=null==(a=e.data)?void 0:a.message,void H({current:0,urls:[s]})}},null,8,["onClick"])),[[c,null==(t=e.data)?void 0:t.message]]):U("",!0),"1"==e.data.type&&T(Me)[o]&&T(Me)[o]?(x(),w(s,{key:2,class:"loader"})):U("",!0),"3"==e.data.type?(x(),w(s,{key:3,class:"item_content_nameSize",onClick:t=>Pe(e.data)},{default:b((()=>{var t;return[j(i,{class:"name"},{default:b((()=>[M(R(e.data.fileName),1)])),_:2},1024),j(i,{class:"size"},{default:b((()=>{var t,a,s;return[M(R(e.data.isLoading?`${Xe(null==(t=e.data)?void 0:t.size)} / 正在传输 ${null==(a=e.data)?void 0:a.progress}`:`${Xe(null==(s=e.data)?void 0:s.size)}`),1)]})),_:2},1024),e.data.isLoading?(x(),w(l,{key:0,percent:null==(t=e.data)?void 0:t.progress},null,8,["percent"])):U("",!0)]})),_:2},1032,["onClick"])):U("",!0),"3"==e.data.type?(x(),w(s,{key:4,class:"item_content_type",onClick:t=>Pe(e.data)},{default:b((()=>[j(a,{src:`../../static/svg/${e.data.suffix}@1x.svg`,mode:"widthFix"},null,8,["src"])])),_:2},1032,["onClick"])):U("",!0)]})),_:2},1024)):U("",!0),"time"!=e.type&&(null==(u=e.data)?void 0:u.userID)==T(Te)?(x(),w(s,{key:2,class:"item_img"},{default:b((()=>[j(a,{src:T(Se),mode:"scaleToFill",onClick:t[1]||(t[1]=e=>Be("my"))},null,8,["src"])])),_:1})):U("",!0)]})),_:2},1032,["class"])})),128))])),_:1},8,["scroll-top","scroll-with-animation","refresher-triggered"]),j(s,{class:"input",style:F(T(_e)),onClic:t[5]||(t[5]=L((()=>{}),["stop"]))},{default:b((()=>[j(s,{class:"input_item"},{default:b((()=>[j(s,{class:"iconfont icon-yuyin"}),j(n,{"adjust-position":!1,"cursor-spacing":25,"show-confirm-bar":!1,onLinechange:We,onFocus:Oe,placeholder:"请输入内容",class:"input_text",maxlength:"280",fixed:"","confirm-type":"send","confirm-hold":!0,style:F(T(he)),onConfirm:Re,modelValue:T(ve),"onUpdate:modelValue":t[2]||(t[2]=e=>N(ve)?ve.value=e:ve=e),onBlur:Ve,focus:T(fe),onKeyboardheightchange:Je},null,8,["style","modelValue","focus"]),j(s,{class:S(["iconfont",T(ce)?"icon-jianpan":"icon-emoji"]),onClick:t[3]||(t[3]=L((e=>Ke(0)),["stop"]))},null,8,["class"]),T(ce)||0!=T(ve).length?U("",!0):(x(),w(s,{key:0,class:"iconfont icon-jia",onClick:t[4]||(t[4]=L((e=>Ke(1)),["stop"]))})),0!==T(ve).length?(x(),w(s,{key:1,class:"send",onTouchstart:L(Re,["prevent","stop"])},{default:b((()=>[M("发送")])),_:1})):U("",!0)])),_:1})])),_:1},8,["style"])])),_:1},8,["style"]),j(s,{class:S(["menu",T(ce)?"active":""]),style:F(T(ye)),onClick:t[12]||(t[12]=L((()=>{}),["stop"]))},{default:b((()=>[j(o,{"scroll-x":"",class:"menu_slection","enable-flex":!0},{default:b((()=>[j(s,{class:"slection_all"},{default:b((()=>[j(s,{class:S(["iconfont","icon-emoji",0==T(ze)?"active":""]),onTouchstart:t[6]||(t[6]=e=>He(0))},null,8,["class"]),j(s,{class:S(["iconfont","icon-jia",1==T(ze)?"active":""]),onTouchstart:t[7]||(t[7]=e=>He(1))},null,8,["class"])])),_:1})])),_:1}),j(o,{class:"List_scroll","scroll-y":"",onTouchmove:t[11]||(t[11]=L((()=>{}),["prevent","stop"]))},{default:b((()=>[j(r,{circular:"",class:"swiper-more",current:T(ze),duration:50,onChange:Qe},{default:b((()=>[j(u,{class:"emoji"},{default:b((()=>[j(o,{"scroll-y":!0,style:{height:"100%",width:"100%"}},{default:b((()=>[j(s,{class:"scroll_style"},{default:b((()=>[(x(!0),z(D,null,I(T(Ne),((e,t)=>(x(),w(s,{class:"scroll_item",key:t,onClick:e=>function(e){let t={uid:Te,fid:$e,msg:Ne[e],type:1,isFriend:be,size:1e4};oe(t)}(t)},{default:b((()=>[q(G("img",{mode:"scaleToFill"},null,512),[[c,e]])])),_:2},1032,["onClick"])))),128))])),_:1})])),_:1})])),_:1}),j(u,{class:"jia"},{default:b((()=>[j(s,{class:"more-function"},{default:b((()=>[j(s,{class:"item"},{default:b((()=>[j(s,{class:"item_box",onClick:t[8]||(t[8]=e=>Ye("tupian"))},{default:b((()=>[j(s,{class:"iconfont icon-shangchuantupian"}),j(s,{class:"text"},{default:b((()=>[M("图片")])),_:1})])),_:1})])),_:1}),j(s,{class:"item"},{default:b((()=>[j(s,{class:"item_box",onClick:t[9]||(t[9]=e=>Ye("wenjian"))},{default:b((()=>[j(s,{class:"iconfont icon-wenjian"}),j(s,{class:"text"},{default:b((()=>[M("文件")])),_:1})])),_:1})])),_:1}),j(s,{class:"item"},{default:b((()=>[j(s,{class:"item_box",onClick:t[10]||(t[10]=e=>Ye("paishe"))},{default:b((()=>[j(s,{class:"iconfont icon-xiangji"}),j(s,{class:"text"},{default:b((()=>[M("拍摄")])),_:1})])),_:1})])),_:1})])),_:1})])),_:1})])),_:1},8,["current"])])),_:1})])),_:1},8,["class","style"])])),_:1},8,["style"])}}},[["__scopeId","data-v-6cea9180"]]);export{re as default};
